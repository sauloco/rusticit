<!DOCTYPE html>
<meta charset="utf-8">
<head>
<title>SISSMO | Transcripción de informes</title>
<script   src="https://code.jquery.com/jquery-2.2.4.min.js"   integrity="sha256-BbhdlvQf/xTY9gja0Dq3HiwQF8LaCRTXxZKRutelT44="   crossorigin="anonymous"></script>
<script src="https://use.fontawesome.com/5ba6f8bf3b.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/0.97.6/css/materialize.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/0.97.6/js/materialize.min.js"></script>
<style>
  html, body, #container_general{
    height: calc (100vh - 64px);
  }
  * {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
  }
  body {
    font: 13px Helvetica, Arial;
  }
  #results {
    font-size: 14px;
    font-weight: bold;
    border: 1px solid #ddd;
    padding: 15px;
    text-align: left;
    min-height: 150px;
  }
  .logo {
    height: 55px;
  }
  #aside_containter{
    overflow: auto;
    max-height: calc(100vh - 84px);
  }
  /* toastjs */
  .alert-hide {
    display: none;
  }
  .alert-toast {
    position: fixed;
    bottom: 10px;
  }
  .alert {
    padding: 15px;
    margin-left: 20px;
    margin-bottom: 20px;
    border: 1px solid transparent;
    border-radius: 4px;
  }

  .alert {
      border-radius: 2px;
      top: 0;
      width: auto;
      clear: both;
      margin-top: 10px;
      position: relative;
      max-width: 100%;
      height: auto;
      min-height: 48px;
      line-height: 1.5em;
      background-color: #323232;
      padding: 10px 25px;
      font-size: 1.1rem;
      font-weight: 300;
      color: #fff;
      display: -webkit-flex;
      display: -ms-flexbox;
      display: flex;
      -webkit-align-items: center;
      -ms-flex-align: center;
      align-items: center;

  }

  .alert-danger {
    border-color: #a94442;
    border-width: 5px;
  }
  .alert-success{
    border-color:#3c763d;
    border-width: 5px;
  }
  /* fin de toastjs*/
</style>
</head>
<body>
  <nav class = "white black-text">
   <div class="nav-wrapper black-text">
     <a href="#" class="brand-logo black-text hide-on-med-and-down"><img class = "logo" src = "http://186.0.181.253:8081/portal/logo/logo_blue.png"/></a>
     <a href="#" class="brand-logo black-text center">TRANSCRIPCION DE INFORMES</a>
   </div>
 </nav>
 <div class = "row" id = "container_general">
   <div class = "col col m8 l8 s12">
    <div class="row">
      <div class = "col s12">
        <div class="card-panel white grey darken-1-text" id="results">
          <span id="final_span" class="final">Toque el micrófono para comenzar con el dictado</span>
          <span id="interim_span" class="interim"></span>
          <p>
        </div>
      </div>
    </div>
    <div class = "row">
      <div class="col s12 ">
        <button id="start_button" class = "btn-floating btn-large waves-effect waves-light red right tooltipped" data-position="left" data-delay="50" data-tooltip="Iniciar o terminar dictado" onclick="startButton(event)"><i id = "start_button_icon" class = "fa fa-microphone"></i></button>
      </div>
    </div>
    <div class="row">
      <div class = "col s12">
        <div class="input-field col s12">
            <i class="fa fa-pencil prefix"></i>
            <textarea id="transcripcion" class="materialize-textarea"></textarea>
            <label for="transcripcion">Corrección de dictado actual</label>
          </div>
      </div>
    </div>
    <div class="row">
      <div class = "col s12 ">
        <button id="accept" class="btn-floating btn-large waves-effect waves-light green right tooltipped" data-position="left" data-delay="50" data-tooltip="Corrección de dictado finalizada" onclick="checkedEnd()"><i class = "fa fa-check"></i></button>
      </div>
    </div>
    <div class="row">
      <div class = "col s12">
        <div class="input-field col s12">
            <i class="fa fa-edit prefix"></i>
            <textarea id="transcripcion_final" class="materialize-textarea"></textarea>
            <label for="transcripcion_final">Corrección de documento completo</label>
          </div>
      </div>
    </div>
    <div class="row">
      <div class = "col s12 ">
        <div class="fixed-action-btn horizontal click-to-toggle" style = "position: relative; right: 0px;">
          <a class="btn-floating btn-large light-blue right tooltipped" data-position="top" data-delay="50" data-tooltip="Click para elegir cómo compartir">
            <i class="fa fa-share-alt"></i>
          </a>
          <ul>
            <li><a id = 'copy_button' class="btn-floating light-blue darken-3 tooltipped" data-position="top" data-delay="50" data-tooltip="Copiar texto corregido" onclick = "copyButton()"><i class="fa fa-clipboard"></i></a></li>
            <li><a id = 'email_button' class="btn-floating light-blue darken-2 tooltipped" data-position="top" data-delay="50" data-tooltip="Enviar por correo electrónico"  onclick = "emailButton()"><i class="fa fa-send"></i></a></li>
          </ul>
        </div>
<!--        <button id="email_button" class="btn-floating btn-large waves-effect waves-light light-blue right tooltipped" data-position="left" data-delay="50" data-tooltip="Enviar por correo electrónico" onclick="emailButton()"><i class = "fa fa-send"></i></button>
        <button id="copy_button" class="btn-floating btn-large waves-effect waves-light light-blue right tooltipped" data-position="left" data-delay="50" data-tooltip="Copiar texto corregido" onclick="copyButton()"><i class = "fa fa-clipboard"></i></button>
-->
      </div>
    </div>
  </div>
  <div class = "col m4 l4 s12" id = "aside_containter">
    <ul class="collapsible" data-collapsible="accordion">
    <li>
      <div class="collapsible-header tooltipped light-blue darken-3 white-text" data-position="left" data-delay="50" data-tooltip="Haga click para expandir"><i class="fa fa-terminal"></i>Comandos de Voz</div>
      <div class="collapsible-body">
        <ul class = "collection" id = "commands_list"></ul>
      </div>
    </li>
    <li>
      <div class="collapsible-header tooltipped light-blue darken-3 white-text" data-position="left" data-delay="50" data-tooltip="Haga click para expandir"><i class = "fa fa-user-md"></i>Abreviaturas médicas</div>
      <div class="collapsible-body">
        <ul class = "collection" id = "abrev_list"></ul>
      </div>
    </li>
  </ul>

  </div>
</div>
<div id = "alert-zone" class = "row alert-hide alert-toast">

  <script>

    transformaciones =
    [
      ['signo coma',', '],
      ['signo punto','. '],
      ['punto final','. '],
      ["punto seguido",'. '],
      ["punto aparte",'.'+String.fromCharCode(13)+String.fromCharCode(10)],
      ["signo dos puntos",': '],
      ["punto y coma",'; '],
      ["signo punto y coma",'; '],
      ["nueva línea",String.fromCharCode(13)+String.fromCharCode(10)],
      ["agregar sangría",'  '],
      ["abrir paréntesis",'('],
      ["cerrar paréntesis",') '],
      ["abrir corchetes",' ['],
      ["cerrar corchete",']'],
      ["cerrar corchetes",']'],
      ["abrir corchete",' ['],
      ["abrir signo interrogación",'¿'],
      ["abrir signo de interrogación",'¿'],
      ["abrir pregunta",'¿'],
      ["empezar pregunta",'¿'],
      ["iniciar pregunta",'¿'],
      ["cerrar signo interrogación",'? '],
      ["cerrar signo de interrogación",'? '],
      ["cerrar pregunta",'? '],
      ["terminar pregunta",'? '],
      ["fin de pregunta",'? '],
      ["abrir signo exclamación",'¡'],
      ["abrir signo de exclamación",'¡'],
      ["abrir exclamación",'¡'],
      ["empezar exclamación",'¡'],
      ["iniciar exclamación",'¡'],
      ["cerrar signo exclamación",'! '],
      ["cerrar signo de exclamación",'! '],
      ["cerrar exclamación",'! '],
      ["terminar exclamación",'! '],
      ["fin de exclamación",'! '],
      ["abrir comillas",'"'],
      ["abre comillas",'"'],
      ["cerrar comillas",'"'],
      ["cierra comillas",'"'],
      ["guión",'-'],
      ["guión bajo",'_'],
      ["agregar espacio",' '],
      ["numeral",'#']
    ]
    acciones =
    [
      ["finalizar dictado",function(){recognition.stop();}]
    ]
    abreviaturas =
    [
        ['trombosis venosa profunda','T.V.P. '],
        ['biopsia', 'Bx ']
    ]
    casos =
    [
      '.'+String.fromCharCode(13)+String.fromCharCode(10),
      String.fromCharCode(13)+String.fromCharCode(10),
      '. ',
      '? ',
      '! '
    ]
    var final_transcript = '';
    var recognizing = false;
    var ignore_onend;
    var start_timestamp;
    var info_upgrade = '<i class = "fa fa-microphone-slash"></i> El servicio de reconocimiento de voz no funciona en este navegador. Actualice <a href="//www.google.com/chrome">Chrome</a> a la versión 25 o posterior.'
    var pressCtrlC = 'Presione Ctrl + C para copiar.<br>(Command + C en Mac.)'
    var nothingToCopy = 'No se ha seleccionado ningún texto para copiar.'
    var info_speak_now = '<i class = "fa fa-assistive-listening-systems"></i> Hable ahora'
    var info_no_speech = '<i class = "fa fa-deaf"></i> No se detectó la voz, deberá ajustar <a href="//support.google.com/chrome/bin/answer.py?hl=en&amp;answer=1407892"> la configuración de su micrófono</a>.'
    var no_mic_found = '<i class = "fa fa-microphone-slash"></i> No se encontró ningún micrófono. Asegúrese que el micrófono está instalado y correctamente <a href="//support.google.com/chrome/bin/answer.py?hl=en&amp;answer=1407892"> configurado.</a>'
    var no_mic_allow = '<i class = "fa fa-microphone-slash"></i> El uso del micrófono está bloqueado. Para modificarlo vaya a chrome://settings/contentExceptions#media-stream'
    var no_mic_allow_now = '<i class = "fa fa-microphone-slash"></i> El uso del micrófono ha sido deshabilitado'
    var touch_mic_to_start = 'Haga click en el micrófono para empezar a hablar'
    var mic_allow_please = '<i class = "fa fa-hand-o-up"></i> Haga click en "Permitir" para habilitar su micrófono'
    var nothingChecked = "No hay texto verificado para agregar al documento."
    var nothingToSend = 'No hay ningún texto en el documento para enviar por correo.'
    var copiedSuccessfully = "El texto del informe se ha copiado satisfactoriamente en el portapapeles. Puede pegarlo donde lo necesite."
    if (!('webkitSpeechRecognition' in window)) {
      upgrade();
    } else {
      var recognition = new webkitSpeechRecognition();
      recognition.continuous = true;
      recognition.interimResults = true;
      recognition.onstart = function() {
        recognizing = true;
        start_button_icon.className = "fa fa-pause"
        mensaje(true,info_speak_now)
      };
      recognition.onerror = function(event) {
        start_button_icon.className = "fa fa-microphone"
        if (event.error == 'no-speech') {
          mensaje(false,info_no_speech)
          ignore_onend = true;
        }
        if (event.error == 'audio-capture') {
          mensaje(false,no_mic_found)
          ignore_onend = true;
        }
        if (event.error == 'not-allowed') {
          if (event.timeStamp - start_timestamp < 100) {
            mensaje(false,no_mic_allow)
          } else {
            mensaje(false,no_mic_allow_now)
          }
          ignore_onend = true;
        }
      };
      recognition.onend = function() {
        recognizing = false;
        start_button_icon.className = "fa fa-microphone"
        if (ignore_onend) {
          return;
        }
        if (!final_transcript) {
          mensaje(false,touch_mic_to_start)
          return;
        }
        if (window.getSelection) {
          window.getSelection().removeAllRanges();
          var range = document.createRange();
          range.selectNode(document.getElementById('transcripcion'));
          window.getSelection().addRange(range);
        }
      };
      recognition.onresult = function(event) {
        var interim_transcript = '';
        for (var i = event.resultIndex; i < event.results.length; ++i) {
          if (event.results[i].isFinal) {
            final_transcript += event.results[i][0].transcript;
          } else {
            interim_transcript += event.results[i][0].transcript;
          }
        }
        final_transcript = capitalize(final_transcript);
        final_span.innerHTML = linebreak(final_transcript);
        interim_span.innerHTML = linebreak(interim_transcript);
        if (final_transcript || interim_transcript) {
          transcripcion.focus()
          transcripcion.value = comandosdevoz(final_transcript) || interim_transcript;
          $('#transcripcion').trigger('autoresize');
        }
      };
    }
    function comandosdevoz(dictado){
      transforma = dictado.toUpperCase()

      largo = transformaciones.length
      for (i = largo; i > 0; i--){

        transformacion_inicio = transformaciones[i-1][0].toUpperCase()
        transformacion_final = transformaciones[i-1][1].toUpperCase()
        transforma = transforma.split(' '+transformacion_inicio+' ').join(transformacion_final)
        transforma = transforma.split(' '+transformacion_inicio).join(transformacion_final)
        transforma = transforma.split(transformacion_inicio+' ').join(transformacion_final)
        transforma    = transforma.split(transformacion_inicio).join(transformacion_final)
      }
      //transforma = capitalizar(transforma)

      largo = abreviaturas.length
      for (i = largo; i > 0; i--){
        transformacion_inicio = abreviaturas[i-1][0].toUpperCase()
        transformacion_final = abreviaturas[i-1][1].toUpperCase()
        transforma = transforma.split(' '+transformacion_inicio+' ').join(transformacion_final)
        transforma = transforma.split(' '+transformacion_inicio).join(transformacion_final)
        transforma = transforma.split(transformacion_inicio+' ').join(transformacion_final)
        transforma = transforma.split(transformacion_inicio).join(transformacion_final)
      }

      return transforma
    }
    function capitalizar(texto){
      for (caso in casos){
        oraciones = texto.split(casos[caso])
        largo_oraciones = oraciones.length
        for (i = largo_oraciones; i > 0; i--){
          oracion = oraciones[i-1]
          oracion = oracion.charAt(0).toUpperCase() + oracion.slice(1);
          oraciones[i-1] = oracion
        }
        texto = oraciones.join(casos[caso])
      }
      return texto
    }
    function upgrade() {
      start_button.style.display = 'none';
      mensaje(false,info_upgrade)
    }
    var two_line = /\n\n/g;
    var one_line = /\n/g;
    function linebreak(s) {
      return s.replace(two_line, '<p></p>').replace(one_line, '<br>');
    }
    var first_char = /\S/;
    function capitalize(s) {
      return s.replace(first_char, function(m) { return m.toUpperCase(); });
    }
    function copyButton() {
      if (recognizing) {
        recognizing = false;
        recognition.stop();
      }
      if (window.getSelection) {
        if (transcripcion_final.value.length > 0){
          transcripcion_final.focus()
          window.getSelection().removeAllRanges();
          var range = document.createRange();
          range.selectNode(document.getElementById('transcripcion_final'));
          window.getSelection().addRange(range);
          if (document.queryCommandSupported('copy')){
            document.execCommand('copy')
            mensaje(true,copiedSuccessfully)
          } else {
            mensaje(true,pressCtrlC)
          }
        } else {
          mensaje(false,nothingToCopy)
        }
      }
    }
    function emailButton() {

      if (recognizing) {
        create_email = true;
        recognizing = false;
        recognition.stop();
        createEmail();
      } else {
        createEmail();
      }
    }
    function createEmail() {
      if (transcripcion_final.value.length > 0){
        var subject = encodeURI('Informe médico | Asistente de voz | SISSMO');
        var body = encodeURI(transcripcion_final.value);
        window.location.href = 'mailto:?subject=' + subject + '&body=' + body;
      } else {
        mensaje(false,nothingToSend)
      }
    }
    function startButton(event) {
      if (recognizing) {
        recognition.stop();
        return;
      }
      final_transcript = '';
      recognition.lang = 'en-US';
      recognition.start();
      ignore_onend = false;
      final_span.innerHTML = '';
      interim_span.innerHTML = '';
      mensaje(true,mic_allow_please)
      start_timestamp = event.timeStamp;
    }

    var current_style;
    function showButtons(style) {
      if (style == current_style) {
        return;
      }
      current_style = style;
      copy_button.style.display = style;
      copy_info.style.display = 'none';
    }
    function checkedEnd(){
      if (transcripcion.value.length > 0){
        transcripcion_final.focus()
        if (transcripcion_final.value.length > 0){
          transcripcion_final.value +=  String.fromCharCode(13) + String.fromCharCode(10)
        }
        transcripcion_final.value += transcripcion.value
        $('#transcripcion_final').trigger('autoresize');
        transcripcion.value = ""
        $('#transcripcion').trigger('autoresize');
      } else {
        mensaje(false,nothingChecked)
      }
    }
    function getDifference(a, b)
    {
        var i = 0;
        var j = 0;
        var result = "";

        while (j < b.length)
        {
            if (a[i] != b[j] || i == a.length)
                result += b[j];
            else
                i++;
            j++;
        }
        return result;
    }
    function listaComandos(){
      arrayLists =
      [
        [transformaciones,'commands_list'],
        [abreviaturas,'abrev_list']
      ]
      for (array_item in arrayLists){
        currentArray = arrayLists[array_item][0]
        for (item in currentArray){
          $("#"+arrayLists[array_item][1]).append($('<ul class = "collection-item"><div class = "chip"><b>'+currentArray[item][1]+'</b></div><span> "'+currentArray[item][0]+'"</span></ul>'))
        }
      }
    }
    $(document).ready(function(){
      $('.tooltipped').tooltip({delay: 50});
      listaComandos()
      $('.collapsible').collapsible({
        accordion : true // A setting that changes the collapsible behavior to expandable instead of the default accordion style
      });
    });
    /* toastjs */
    var idToast = "alert-zone";

    setID = function (idnuevo){
      idToast = idnuevo;
    }
    getID = function(){
      return idToast;
    }

    mensaje = function(success,message){
      $('#'+idToast).removeClass("alert-hide");
      setTimeout(function(){
        $('#'+idToast).addClass("alert-hide");
      }, 5000);
      $("#"+idToast).html('<div class="alert alert-'+((success)?'success':'danger')+'" role="alert"><span>'+message+'</span></div>');
    }
    /* fin de toastjs */
  </script>
<body>